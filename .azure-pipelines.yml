trigger:
  batch: true
  branches:
    include:
      - main
  tags:
    include:
      - v*

pr:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

steps:
- script: |
    set -ex
    ./eng/build.sh
  displayName: build

- script: |
    set -ex
    cargo test --release --target x86_64-unknown-linux-musl
    sudo target/x86_64-unknown-linux-musl/release/avml --compress output.lime
  displayName: test

- task: PublishPipelineArtifact@0
  displayName: publish avml
  inputs:
    targetPath: target/x86_64-unknown-linux-musl/release/avml
    artifactName: avml

- task: PublishPipelineArtifact@0
  displayName: publish avml-minimal
  inputs:
    targetPath: target/x86_64-unknown-linux-musl/release/avml-minimal
    artifactName: avml-minimal

- task: PublishPipelineArtifact@0
  displayName: publish avml-convert
  inputs:
    targetPath: target/x86_64-unknown-linux-musl/release/avml-convert
    artifactName: avml-convert

- task: PublishPipelineArtifact@0
  displayName: publish avml-upload
  inputs:
    targetPath: target/x86_64-unknown-linux-musl/release/avml-upload
    artifactName: avml-upload

- task: ComponentGovernanceComponentDetection@0
  inputs:
    scanType: 'Register'
    verbosity: 'Verbose'
    alertWarningLevel: 'High'
